<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èŒå•†åŸ - 115 è›‡å¹´ç©©å®šç‰ˆ</title>
    <link rel="icon" href="https://img.icons8.com/color/96/dinosaur.png">
    <style>
        :root { --primary: #7db9a1; --bg: #fdfaf7; --shadow: 0 12px 40px rgba(0,0,0,0.08); --danger: #e63946; --gold: #ffd700; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); margin: 0; overflow-x: hidden; }
        
        /* è§£æ±ºé¸å–®èˆ‡å…§å®¹è¡çª */
        header { background: white; padding: 0 5%; display: flex; align-items: center; height: 70px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .drawer { width: 280px; background: white; height: 100%; position: fixed; left: 0; top: 0; z-index: 2000; transition: 0.4s; padding: 40px 20px; box-sizing: border-box; box-shadow: 10px 0 30px rgba(0,0,0,0.1); }
        .drawer.closed { transform: translateX(-100%); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1500; }

        /* ä¿®å¾©è³¼è²·ç´€éŒ„é¢æ¿ */
        #history-panel { position: fixed; right: 0; top: 0; width: 320px; height: 100%; background: white; z-index: 2100; transition: 0.4s; padding: 25px; box-shadow: -10px 0 30px rgba(0,0,0,0.1); overflow-y: auto; }
        #history-panel.closed { transform: translateX(100%); }

        /* è§£æ±ºå½ˆçª—è¢«é®æ“‹å•é¡Œ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 3000; backdrop-filter: blur(5px); }
        .modal-card { background: white; padding: 30px; border-radius: 30px; width: 90%; max-width: 380px; position: relative; max-height: 80vh; overflow-y: auto; text-align: center; }
        
        /* é¼ æ¨™ç‰¹æ•ˆä¿ç•™ */
        .card { background: white; border-radius: 25px; padding: 20px; transition: 0.4s; box-shadow: var(--shadow); cursor: pointer; }
        .card:hover { transform: translateY(-10px); }
        .btn-main { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 15px; width: 100%; font-weight: 700; cursor: pointer; }
        .btn-close { position: absolute; right: 15px; top: 15px; background: #eee; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<header>
    <button onclick="toggleDrawer()" style="font-size:24px; border:none; background:none; color:var(--primary); cursor:pointer;">â˜°</button>
    <div style="margin-left:15px; font-weight:900; color:var(--primary); font-size:20px;">èŒå•†åŸ</div>
</header>

<div id="drawer-overlay" class="hidden overlay" onclick="toggleDrawer()"></div>
<div id="drawer-panel" class="drawer closed">
    <div onclick="openModal('modal-scratch')" style="padding:15px; cursor:pointer;">ğŸ§§ è›‡å¹´åˆ®åˆ®æ¨‚</div>
    <div onclick="openModal('modal-signin')" style="padding:15px; cursor:pointer;">ğŸ“… æ¯æ—¥ç°½åˆ°</div>
    <div onclick="showPage('cart')" style="padding:15px; cursor:pointer;">ğŸ›’ è³¼ç‰©è»Š (<span id="cart-count">0</span>)</div>
    <div onclick="toggleHistoryPanel()" style="padding:15px; cursor:pointer;">ğŸ“œ è³¼è²·ç´€éŒ„</div>
    <div onclick="openModal('user-modal')" style="padding:15px; cursor:pointer;">ğŸ‘¤ æœƒå“¡ä¸­å¿ƒ</div>
    <div onclick="logout()" style="padding:15px; cursor:pointer; color:var(--danger); margin-top:30px;">ğŸšª ç™»å‡ºå¸³è™Ÿ</div>
</div>

<div id="history-panel" class="closed">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;"><h3>ğŸ›ï¸ è³¼è²·ç´€éŒ„</h3><button onclick="toggleHistoryPanel()">âœ•</button></div>
    <div id="history-list"></div>
</div>

<div class="container" style="padding: 20px; max-width: 900px; margin: auto;">
    <div id="page-products" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:20px;"></div>
    <div id="page-cart" class="hidden">
        <h2>ğŸ›’ æˆ‘çš„è³¼ç‰©è»Š</h2>
        <div id="cart-container"></div>
        <div style="text-align:right; margin-top:20px;">
            <h3>ç¸½è¨ˆ: $<span id="cart-total">0</span></h3>
            <p style="color:var(--primary);">å›é¥‹ç©åˆ† (1%): <span id="reward-points">0</span></p>
            <button class="btn-main" onclick="checkout()">ç¢ºèªçµå¸³</button>
        </div>
    </div>
</div>

<div id="user-modal" class="hidden modal-overlay"><div class="modal-card">
    <button class="btn-close" onclick="closeModals()">âœ•</button>
    <h3>æœƒå“¡ä¸­å¿ƒ</h3>
    <div style="text-align:left; background:#f9f9f9; padding:15px; border-radius:15px;">
        <p>å¸³è™Ÿï¼š<b id="m-email"></b></p>
        <p>æš±ç¨±ï¼š<b id="m-name"></b></p>
        <p>å¯†ç¢¼ï¼š<b>********</b></p>
        <p>ç©åˆ†ï¼š<b id="m-points">0</b></p>
    </div>
</div></div>

<div id="modal-scratch" class="hidden modal-overlay"><div class="modal-card" style="background:var(--danger); color:white;">
    <button class="btn-close" onclick="closeModals()">âœ•</button>
    <h2>ğŸ è›‡å¹´åˆ®åˆ®æ¨‚</h2>
    <p>10 ç©åˆ†é–‹åˆ®å¥½é‹</p>
    <div id="scratch-container" style="background:white; height:120px; margin:15px 0; border-radius:10px; color:black; line-height:120px;">
        <div id="prize-text">ç­‰å¾…ä¸­...</div>
    </div>
    <button class="btn-main" style="background:var(--gold); color:black;" onclick="startScratch()">é–‹å§‹é æ¸¬</button>
</div></div>

<script>
    const API_URL = "/api"; 
    let allProducts = [], cart = [], currentUser = null, userPoints = 0;

    function toggleDrawer() { document.getElementById('drawer-panel').classList.toggle('closed'); document.getElementById('drawer-overlay').classList.toggle('hidden'); }
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden')); }
    function toggleHistoryPanel() { 
        const p = document.getElementById('history-panel'); 
        p.classList.toggle('closed'); 
        if(!p.classList.contains('closed')) loadOrders(); 
    }

    async function loadProducts() {
        const res = await fetch(`${API_URL}/products`);
        allProducts = await res.json();
        document.getElementById('page-products').innerHTML = allProducts.map(p => `
            <div class="card" onclick="alert('é»æ“Šäº†å•†å“')">
                <img src="${p.image_url}" style="width:100%; border-radius:15px;">
                <h3>${p.name}</h3><p style="color:var(--primary); font-weight:800;">$${p.price}</p>
            </div>`).join('');
    }

    async function checkout() {
        if(cart.length===0) return alert("è³¼ç‰©è»Šç©ºçš„");
        const total = document.getElementById('cart-total').innerText;
        const res = await fetch(`${API_URL}/checkout`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: currentUser.email, products: "å•†å“åˆ—è¡¨", total, image_url: cart[0].image_url })
        });
        if(res.ok) { alert("çµå¸³æˆåŠŸï¼1%å›é¥‹å·²å…¥å¸³"); cart=[]; showPage('products'); }
    }

    // åˆå§‹åŒ–ç™»å…¥èˆ‡è³‡æ–™æŠ“å–
    async function init() {
        const saved = localStorage.getItem('èŒå•†åŸ_user');
        if(saved) {
            currentUser = JSON.parse(saved);
            document.getElementById('m-email').innerText = currentUser.email;
        }
        loadProducts();
    }
    init();
</script>
</body>
</html>
