<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŒå•†åŸ</title>
    <style>
        :root { 
            --primary: #7db9a1; --accent: #f4b183; --bg: #fdfaf7; 
            --text: #4a4a4a; --danger: #e67e73; --shadow: 0 8px 24px rgba(0,0,0,0.05); 
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; height: 60px; box-sizing: border-box; }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary); cursor: pointer; }
        .nav-right { display: flex; align-items: center; gap: 8px; }
        .user-name-btn { background: #f0f2f0; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--primary); font-size: 12px; }
        .container { max-width: 850px; margin: 30px auto; padding: 0 20px; }
        .hidden { display: none !important; }
        .card { background: white; border-radius: 20px; box-shadow: var(--shadow); overflow: hidden; margin-bottom: 20px; }
        .btn-submit { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: 600; }
        .input-field { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #e1e1e1; border-radius: 10px; box-sizing: border-box; }
        .order-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 14px; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="showPage('products')">èŒå•†åŸ</div>
    <div class="nav-right">
        <button class="user-name-btn" onclick="showPage('cart')">ğŸ›’ è³¼ç‰©è»Š (<span id="cart-count">0</span>)</button>
        <span id="user-display" class="user-name-btn hidden" onclick="toggleUserModal()"></span>
        <button id="login-nav-btn" class="user-name-btn" onclick="showPage('login')">ç™»å…¥</button>
    </div>
</header>

<div class="container">
    <div id="page-products">
        <div id="product-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:25px;">è¼‰å…¥ä¸­...</div>
    </div>

    <div id="user-modal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:1000; display:flex; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:25px; width:360px; max-height:80vh; overflow-y:auto;">
            <h3>æœƒå“¡ä¸­å¿ƒ</h3>
            
            <div id="user-info-view">
                <p>æš±ç¨±ï¼š<b id="display-username"></b></p>
                <p>ä»‹ç´¹ï¼š<span id="display-bio"></span></p>
                <button class="btn-submit" style="background:#f0f2f0; color:#4a4a4a;" onclick="setEditMode(true)">ç·¨è¼¯å€‹äººè³‡æ–™</button>
            </div>
            
            <div id="user-info-edit" class="hidden">
                <input id="edit-username" class="input-field" placeholder="æ–°æš±ç¨±">
                <textarea id="edit-bio" class="input-field" style="height:80px;" placeholder="è‡ªæˆ‘ä»‹ç´¹"></textarea>
                <button class="btn-submit" onclick="saveProfile()">å„²å­˜</button>
            </div>

            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
            
            <h4>æ­·å²è¨‚å–®</h4>
            <div id="order-history">
                <div class="order-item"><span>2025/11/29 - æ‹›ç‰Œç‚’é£¯</span><b>NT$ 85</b></div>
                <div class="order-item"><span>2025/11/25 - æ—¥å¼å’–å“©é£¯</span><b>NT$ 120</b></div>
                <div class="order-item"><span>2025/10/15 - è¦ä»ç‚’é£¯</span><b>NT$ 95</b></div>
            </div>

            <button onclick="logout()" style="color:var(--danger); background:none; border:none; margin-top:20px; cursor:pointer; width:100%;">ç™»å‡º</button>
            <button onclick="toggleUserModal()" style="color:#bbb; background:none; border:none; margin-top:10px; cursor:pointer; width:100%;">é—œé–‰</button>
        </div>
    </div>

    <div id="page-login" class="hidden">
        <div class="card" style="padding:40px; max-width:350px; margin:0 auto;">
            <h2 style="text-align:center;">æœƒå“¡ç™»å…¥</h2>
            <input id="login-email" class="input-field" placeholder="Email">
            <input type="password" id="login-password" class="input-field" placeholder="å¯†ç¢¼">
            <button class="btn-submit" onclick="apiLogin()">é€²å…¥å•†åŸ</button>
        </div>
    </div>
</div>

<script>
    const API_URL = "/api";
    let currentUser = JSON.parse(localStorage.getItem('èŒå•†åŸ_user')) || null;

    function showPage(p) {
        document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
        document.getElementById('page-' + p).classList.remove('hidden');
    }

    function toggleUserModal() {
        const m = document.getElementById('user-modal');
        m.classList.toggle('hidden');
        if(!m.classList.contains('hidden')) {
            document.getElementById('display-username').innerText = currentUser.username;
            document.getElementById('display-bio').innerText = currentUser.bio || "ç„¡";
            setEditMode(false);
        }
    }

    function setEditMode(edit) {
        document.getElementById('user-info-view').className = edit ? 'hidden' : '';
        document.getElementById('user-info-edit').className = edit ? '' : 'hidden';
        if(edit) {
            document.getElementById('edit-username').value = currentUser.username;
            document.getElementById('edit-bio').value = currentUser.bio || "";
        }
    }

    async function saveProfile() {
        const newName = document.getElementById('edit-username').value;
        const newBio = document.getElementById('edit-bio').value;
        
        // é€™è£¡ç™¼é€ API æ›´æ–° (æ¨¡æ“¬)
        currentUser.username = newName;
        currentUser.bio = newBio;
        updateUI();
        setEditMode(false);
        alert("è³‡æ–™å·²æ›´æ–°ï¼");
    }

    function updateUI() {
        const display = document.getElementById('user-display');
        const loginBtn = document.getElementById('login-nav-btn');
        if (currentUser) {
            display.innerText = currentUser.username + "(å·²ç™»å…¥)";
            display.classList.remove('hidden');
            loginBtn.classList.add('hidden');
            localStorage.setItem('èŒå•†åŸ_user', JSON.stringify(currentUser));
        } else {
            display.classList.add('hidden');
            loginBtn.classList.remove('hidden');
        }
    }

    async function loadProducts() {
        const res = await fetch(`${API_URL}/products`);
        const data = await res.json();
        document.getElementById('product-list').innerHTML = data.map(p => `
            <div class="card">
                <img src="${p.image_url}" style="width:100%; height:200px; object-fit:cover;">
                <div style="padding:15px;">
                    <h3>${p.name}</h3>
                    <p style="color:var(--danger); font-weight:bold;">NT$ ${p.price}</p>
                </div>
            </div>`).join('');
    }

    function logout() { currentUser = null; updateUI(); location.reload(); }
    
    updateUI();
    loadProducts();
</script>
</body>
</html>
